# API 服务过载错误处理

## 错误信息

```
API 服务暂时过载，请稍后重试。

建议：
1. 等待几秒钟后重试
2. 如果问题持续，请检查 API 提供商的服务状态
3. 考虑降低请求频率

原始错误: Error code: 503 - {'code': 50508, 'message': 'System is too busy now. Please try again later.', 'data': None}
```

## 问题说明

这是 **API 提供商的临时服务过载**，不是代码错误。错误代码 `50508` 表示：
- API 服务当前负载过高
- 需要等待一段时间后重试
- 这是临时性问题，通常会在几秒到几分钟内恢复

## 错误处理

后端已经正确识别并处理了这类错误：

1. **错误检测**：自动识别 503 错误和 `50508` 错误码
2. **友好提示**：显示中文错误消息，提供解决建议
3. **错误传播**：通过流式响应将错误信息传递给前端

## 解决方案

### 用户操作建议

1. **等待后重试**：
   - 等待 5-10 秒后重新发送请求
   - 如果仍然失败，等待更长时间（30秒-1分钟）

2. **检查服务状态**：
   - 访问 API 提供商的服务状态页面
   - 确认是否有已知的服务问题

3. **降低请求频率**：
   - 如果频繁遇到此错误，考虑降低请求频率
   - 避免同时发送多个请求

### 技术改进（可选）

如果需要自动重试机制，可以考虑：

1. **指数退避重试**：
   ```python
   import asyncio
   from tenacity import retry, stop_after_attempt, wait_exponential
   
   @retry(
       stop=stop_after_attempt(3),
       wait=wait_exponential(multiplier=1, min=2, max=10),
       retry=retry_if_exception_type(APIOverloadError)
   )
   async def call_llm_with_retry(...):
       ...
   ```

2. **注意事项**：
   - 流式响应中自动重试较复杂，因为响应已经开始
   - 建议用户手动重试，而不是自动重试
   - 如果添加自动重试，需要确保不会导致重复响应

## 相关错误码

| 错误码 | 含义 | 处理方式 |
|--------|------|----------|
| 503 / 50508 | 服务过载 | 等待后重试 |
| 429 | 速率限制 | 降低请求频率 |
| 401 | API 密钥无效 | 检查配置 |
| 20012 | 模型不存在 | 检查模型配置 |

## 错误处理代码位置

- `backend/app/services/copilot/copilot_service.py` (行 554-563)
- 自动识别并显示友好的错误消息

## 监控建议

如果频繁遇到此错误，建议：

1. **监控错误率**：记录 503 错误的发生频率
2. **分析模式**：检查是否有特定的时间段或操作导致错误
3. **联系提供商**：如果错误持续，联系 API 提供商支持团队

## 总结

这是 **正常的 API 服务过载错误**，不是代码问题。错误处理已经正确实现，用户只需等待后重试即可。

