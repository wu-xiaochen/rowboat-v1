# å·¥å…·è°ƒç”¨æ¶ˆæ¯é¡ºåºè°ƒè¯•æŒ‡å—

## é—®é¢˜æè¿°

é”™è¯¯ä¿¡æ¯ï¼š
```
Error code: 400 - {'code': 20015, 'message': '"messages" in request are illegal: Message has tool role, but there was no previous assistant message with a tool call!..', 'data': None}
```

## è°ƒè¯•æ­¥éª¤

### 1. æŸ¥çœ‹åç«¯æ—¥å¿—

åç«¯æœåŠ¡ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š

- **è¿­ä»£å¼€å§‹å‰çš„æ¶ˆæ¯é¡ºåºéªŒè¯**ï¼š
  ```
  ğŸ” è¿­ä»£ 2 å¼€å§‹å‰ï¼ŒéªŒè¯æ¶ˆæ¯é¡ºåº:
    æ¶ˆæ¯æ€»æ•°: X
    [X-3] AIMessage (tool_calls: Y)
    [X-2] ToolMessage (tool_call_id: ...)
    [X-1] ...
  ```

- **AIMessage æ„å»ºè¿‡ç¨‹**ï¼š
  ```
  âœ… æ‰‹åŠ¨æ„å»ºAIMessageï¼ŒåŒ…å« N ä¸ªå·¥å…·è°ƒç”¨
    ğŸ”§ ToolCall: name=..., id=...
  ```

- **ToolMessage æ·»åŠ éªŒè¯**ï¼š
  ```
  âœ… æˆåŠŸæ·»åŠ  M ä¸ªToolMessageåˆ°æ¶ˆæ¯åˆ—è¡¨
  ```

- **é”™è¯¯æ£€æµ‹**ï¼š
  ```
  âŒ é”™è¯¯ï¼šæœ€åä¸€æ¡AIMessageæ²¡æœ‰tool_callsï¼Œä½†å­˜åœ¨ N ä¸ªToolMessage
  âš ï¸ è­¦å‘Šï¼šå‘ç°ä¸åŒ¹é…çš„tool_call_id: {...}
  ```

### 2. å…³é”®æ£€æŸ¥ç‚¹

#### æ£€æŸ¥ç‚¹ 1ï¼šç¬¬ä¸€è½®è¿­ä»£å®Œæˆå
- ç¡®è®¤ `AIMessage` å·²æ­£ç¡®æ„å»ºï¼ŒåŒ…å«æ‰€æœ‰ `tool_calls`
- ç¡®è®¤ `ToolMessage` çš„ `tool_call_id` ä¸ `AIMessage` ä¸­çš„ `tool_calls` çš„ `id` åŒ¹é…

#### æ£€æŸ¥ç‚¹ 2ï¼šä¸‹ä¸€è½®è¿­ä»£å¼€å§‹å‰
- ç¡®è®¤æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯ `ToolMessage`
- ç¡®è®¤å‰ä¸€æ¡æ¶ˆæ¯æ˜¯åŒ…å« `tool_calls` çš„ `AIMessage`
- ç¡®è®¤ `ToolMessage` çš„ `tool_call_id` åœ¨ `AIMessage` çš„ `tool_calls` ä¸­

#### æ£€æŸ¥ç‚¹ 3ï¼šLLM è°ƒç”¨å‰
- ç¡®è®¤ `current_messages` çš„æ¶ˆæ¯é¡ºåºæ­£ç¡®
- ç¡®è®¤æ²¡æœ‰å­¤ç«‹çš„ `ToolMessage`ï¼ˆæ²¡æœ‰å¯¹åº”çš„ `AIMessage`ï¼‰

### 3. å¸¸è§é—®é¢˜

#### é—®é¢˜ 1ï¼šAIMessage æ²¡æœ‰ tool_calls
**ç—‡çŠ¶**ï¼šæ—¥å¿—æ˜¾ç¤º `âŒ é”™è¯¯ï¼šæœ€åä¸€æ¡AIMessageæ²¡æœ‰tool_calls`

**åŸå› **ï¼š
- `final_ai_chunk` ä¸åŒ…å« `tool_calls`
- `all_tool_calls_collected` ä¸ºç©º
- `tool_calls_in_this_iteration` ä¸ºç©º

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æµå¼å“åº”ä¸­æ˜¯å¦æ­£ç¡®æ”¶é›†äº†å·¥å…·è°ƒç”¨
- æ£€æŸ¥å·¥å…·è°ƒç”¨è§£æé€»è¾‘

#### é—®é¢˜ 2ï¼štool_call_id ä¸åŒ¹é…
**ç—‡çŠ¶**ï¼šæ—¥å¿—æ˜¾ç¤º `âš ï¸ è­¦å‘Šï¼šå‘ç°ä¸åŒ¹é…çš„tool_call_id`

**åŸå› **ï¼š
- `AIMessage` ä¸­çš„ `tool_calls` çš„ `id` ä¸ `ToolMessage` çš„ `tool_call_id` ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿ä½¿ç”¨ `tool_calls_in_this_iteration` æ„å»º `AIMessage`
- ç¡®ä¿ `ToolMessage` ä½¿ç”¨ç›¸åŒçš„ `tool_call_id`

#### é—®é¢˜ 3ï¼šæ¶ˆæ¯é¡ºåºé”™è¯¯
**ç—‡çŠ¶**ï¼šæ—¥å¿—æ˜¾ç¤º `âŒ é”™è¯¯ï¼šæœ€åä¸€æ¡æ˜¯ ToolMessageï¼Œä½†å‰ä¸€æ¡ä¸æ˜¯ AIMessage`

**åŸå› **ï¼š
- åœ¨æ·»åŠ  `ToolMessage` ä¹‹å‰ï¼Œæ²¡æœ‰å…ˆæ·»åŠ åŒ…å« `tool_calls` çš„ `AIMessage`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿åœ¨æ·»åŠ  `ToolMessage` ä¹‹å‰ï¼Œå…ˆæ·»åŠ åŒ…å« `tool_calls` çš„ `AIMessage`
- ä½¿ç”¨ä¿®å¤é€»è¾‘è‡ªåŠ¨ä¿®å¤

### 4. æ—¥å¿—åˆ†æç¤ºä¾‹

#### æ­£å¸¸æµç¨‹
```
ğŸš€ è¿­ä»£ 1 å¼€å§‹ï¼Œè°ƒç”¨ LLMï¼Œæ¶ˆæ¯æ€»æ•°: 3
âœ… æ‰‹åŠ¨æ„å»ºAIMessageï¼ŒåŒ…å« 1 ä¸ªå·¥å…·è°ƒç”¨
  ğŸ”§ ToolCall: name=search_relevant_tools, id=call_abc123
âœ… æˆåŠŸæ·»åŠ  1 ä¸ªToolMessageåˆ°æ¶ˆæ¯åˆ—è¡¨
ğŸ” è¿­ä»£ 1 å®Œæˆåçš„æ¶ˆæ¯åˆ—è¡¨çŠ¶æ€:
  [0] AIMessage (tool_calls: 1)
  [1] ToolMessage (tool_call_id: call_abc123)

ğŸ” è¿­ä»£ 2 å¼€å§‹å‰ï¼ŒéªŒè¯æ¶ˆæ¯é¡ºåº:
  æ¶ˆæ¯æ€»æ•°: 4
  [1] AIMessage (tool_calls: 1)
  [2] ToolMessage (tool_call_id: call_abc123)
âœ… æ¶ˆæ¯é¡ºåºéªŒè¯é€šè¿‡
ğŸš€ è¿­ä»£ 2 å¼€å§‹ï¼Œè°ƒç”¨ LLMï¼Œæ¶ˆæ¯æ€»æ•°: 4
```

#### é”™è¯¯æµç¨‹
```
ğŸš€ è¿­ä»£ 1 å¼€å§‹ï¼Œè°ƒç”¨ LLMï¼Œæ¶ˆæ¯æ€»æ•°: 3
âš ï¸ è­¦å‘Šï¼šæ²¡æœ‰æ·»åŠ AIMessageï¼Œä½†å­˜åœ¨å·¥å…·è°ƒç”¨: [...]
âŒ é”™è¯¯ï¼šæœ€åä¸€æ¡AIMessageæ²¡æœ‰tool_callsï¼Œä½†å­˜åœ¨ 1 ä¸ªToolMessage
âŒ æ— æ³•ä¿®å¤ï¼šæ²¡æœ‰å·¥å…·è°ƒç”¨ä¿¡æ¯

ğŸ” è¿­ä»£ 2 å¼€å§‹å‰ï¼ŒéªŒè¯æ¶ˆæ¯é¡ºåº:
  æ¶ˆæ¯æ€»æ•°: 4
  [1] AIMessage (tool_calls: 0)
  [2] ToolMessage (tool_call_id: call_abc123)
âŒ é”™è¯¯ï¼šæœ€åä¸€æ¡æ˜¯ ToolMessageï¼Œä½†å‰ä¸€æ¡ AIMessage æ²¡æœ‰ tool_calls
```

### 5. ä¿®å¤ç­–ç•¥

1. **é¢„é˜²æ€§ä¿®å¤**ï¼šåœ¨æ·»åŠ  `ToolMessage` ä¹‹å‰ï¼Œç¡®ä¿ `AIMessage` å·²æ­£ç¡®æ„å»º
2. **æ£€æµ‹æ€§ä¿®å¤**ï¼šåœ¨ä¸‹ä¸€è½®è¿­ä»£å¼€å§‹å‰ï¼ŒéªŒè¯æ¶ˆæ¯é¡ºåºï¼Œå‘ç°é—®é¢˜æ—¶é€€å‡ºå¾ªç¯
3. **è‡ªåŠ¨ä¿®å¤**ï¼šå¦‚æœå‘ç°é—®é¢˜ï¼Œå°è¯•é‡æ–°æ„å»º `AIMessage`

### 6. å¦‚ä½•æŸ¥çœ‹æ—¥å¿—

#### æ–¹æ³• 1ï¼šæŸ¥çœ‹åç«¯æœåŠ¡æ§åˆ¶å°è¾“å‡º
å¦‚æœåç«¯æœåŠ¡åœ¨ç»ˆç«¯è¿è¡Œï¼Œæ—¥å¿—ä¼šç›´æ¥è¾“å‡ºåˆ°æ§åˆ¶å°ã€‚

#### æ–¹æ³• 2ï¼šæŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
```bash
# å¦‚æœä½¿ç”¨ systemd
journalctl -u uvicorn -f

# å¦‚æœä½¿ç”¨ Docker
docker logs -f <container_name>
```

#### æ–¹æ³• 3ï¼šé‡å®šå‘åˆ°æ–‡ä»¶
åœ¨å¯åŠ¨åç«¯æœåŠ¡æ—¶ï¼Œå°†è¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶ï¼š
```bash
uvicorn app.main:app --reload --port 8001 2>&1 | tee /tmp/backend.log
```

### 7. ä¸‹ä¸€æ­¥

1. è¿è¡Œæµ‹è¯•ï¼Œè§¦å‘é”™è¯¯
2. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œæ‰¾åˆ°é—®é¢˜æ‰€åœ¨
3. æ ¹æ®æ—¥å¿—ä¿¡æ¯ï¼Œå®šä½å…·ä½“çš„é”™è¯¯ç‚¹
4. ä¿®å¤é—®é¢˜ï¼Œé‡æ–°æµ‹è¯•

## ç›¸å…³æ–‡ä»¶

- `backend/app/services/copilot/copilot_service.py` - Copilot æœåŠ¡å®ç°
- `docs/TOOL_CALL_MESSAGE_FIX_V2.md` - ä¿®å¤æ–¹æ¡ˆæ–‡æ¡£
