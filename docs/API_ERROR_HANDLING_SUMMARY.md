# API 错误处理总结

## 概述

后端 Copilot 服务已经实现了完善的错误处理机制，能够识别和处理各种 API 错误，并向用户显示友好的错误消息。

## 已实现的错误处理

### 1. API 服务过载 (503 / 50508)

**错误信息**：
```
API 服务暂时过载，请稍后重试。

建议：
1. 等待几秒钟后重试
2. 如果问题持续，请检查 API 提供商的服务状态
3. 考虑降低请求频率
```

**检测条件**：
- HTTP 状态码 503
- 错误码 50508
- 错误消息包含 "too busy"

**处理方式**：提示用户等待后重试

### 2. 模型不存在 (20012)

**错误信息**：
```
模型配置错误：模型不存在或不可用。

请检查：
1. 模型名称是否正确（当前: {model_name}）
2. 模型是否在 API 提供商处可用
3. API 密钥是否有效
```

**检测条件**：
- 错误消息包含 "Model does not exist"
- 错误码 20012

**处理方式**：提示检查模型配置

### 3. API 密钥无效 (401)

**错误信息**：
```
API 密钥无效或已过期。

请检查：
1. API 密钥是否正确配置
2. API 密钥是否已过期
3. API 密钥是否有足够的权限
```

**检测条件**：
- HTTP 状态码 401
- 错误消息包含 "unauthorized" 或 "invalid api key"

**处理方式**：提示检查 API 密钥配置

### 4. 配额/计费错误 (429)

**错误信息**：
```
API 配额已用完或计费问题。

请检查：
1. API 账户是否有足够的配额
2. 账户余额是否充足
3. 是否需要升级账户
```

**检测条件**：
- HTTP 状态码 429
- 错误消息包含 "quota"、"billing" 或 "credits"

**处理方式**：提示检查账户配额和余额

### 5. 其他错误

**错误信息**：
```
错误: {原始错误信息}
```

**处理方式**：显示原始错误信息

## 错误处理流程

```
API 调用
  ↓
捕获异常
  ↓
解析错误信息
  ↓
匹配错误类型
  ↓
生成友好错误消息
  ↓
通过流式响应发送错误事件
  ↓
前端显示错误消息
```

## 代码位置

- **错误处理逻辑**：`backend/app/services/copilot/copilot_service.py` (行 549-601)
- **错误事件格式**：`CopilotStreamEvent(type="error", content=error_message)`

## 前端错误处理

前端在 `apps/rowboat/app/projects/[projectId]/copilot/use-copilot.tsx` 中处理错误事件：

```typescript
} else if (currentEventType === 'error') {
    const errorMessage = data.error || data.content || 'Stream error';
    console.error('❌ Stream error:', errorMessage);
    setError(errorMessage);
    setLoading(false);
    inFlightRef.current = false;
    return;
}
```

## 最佳实践

1. **用户友好**：所有错误消息都使用中文，提供清晰的解决建议
2. **信息完整**：保留原始错误信息，便于调试
3. **分类处理**：根据错误类型提供不同的处理建议
4. **流式兼容**：错误通过流式响应传递，不影响其他功能

## 未来改进（可选）

1. **自动重试**：对于临时性错误（如 503），可以考虑自动重试
2. **错误统计**：记录错误发生频率，用于监控和分析
3. **降级策略**：在服务过载时，可以考虑使用备用 API 端点
4. **用户通知**：对于持续的错误，可以向用户发送通知

## 总结

当前的错误处理机制已经能够：
- ✅ 正确识别各种 API 错误
- ✅ 提供友好的中文错误消息
- ✅ 给出具体的解决建议
- ✅ 通过流式响应正确传递错误

用户遇到 API 服务过载等临时性错误时，只需按照提示等待后重试即可。

