# Copilot功能修复详细计划

## 问题总结

1. **工具搜索问题**：
   - COMPOSIO_SEARCH_TOOLS返回405错误（方法不对）
   - 遍历toolkit很慢且结果不准确
   - 没有优先使用workflow中已有的工具

2. **用户交互问题**：
   - Copilot在询问用户后没有等待输入，直接进入创建流程

3. **多智能体对话错误**：
   - 收到253个事件但没有生成消息

4. **智能体连接问题**：
   - 生成的智能体没有正确连接到其他智能体

5. **工具匹配问题**：
   - 搜索到的工具没有正确匹配并配置到智能体中

## 修复计划

### 阶段1：工具搜索修复

#### 1.1 修复COMPOSIO_SEARCH_TOOLS API调用
- **问题**：当前使用POST `/tools/COMPOSIO_SEARCH_TOOLS/execute`返回405
- **原项目实现**：使用`composio.tools.execute('COMPOSIO_SEARCH_TOOLS', ...)`（composio-core库）
- **解决方案**：
  - 方案A：安装并使用`composio-core` Python库（推荐）
  - 方案B：使用正确的HTTP API端点（需要确认正确的端点）
- **测试**：验证工具搜索能正确返回结果

#### 1.2 实现工具优先级
- **问题**：没有优先使用workflow中已有的工具
- **原项目逻辑**：在搜索工具前，先检查workflow.tools中是否已有匹配的工具
- **实现步骤**：
  1. 在`search_relevant_tools`函数中，先检查workflow.tools
  2. 如果找到匹配的工具，优先返回这些工具
  3. 如果不够，再搜索新工具并合并结果
- **测试**：验证已有工具被优先使用

#### 1.3 优化工具搜索性能
- **问题**：遍历toolkit很慢
- **解决方案**：
  - 优先使用COMPOSIO_SEARCH_TOOLS（如果可用）
  - 如果必须遍历，限制搜索范围并优化
- **测试**：验证搜索速度提升

### 阶段2：用户交互修复

#### 2.1 修复等待用户输入
- **问题**：Copilot询问后直接创建，不等待用户回复
- **原项目逻辑**：系统提示词中明确"Only ask for clarification once, using up to 4 concise, bullet-point questions"
- **解决方案**：
  1. 检查系统提示词，确保明确指导LLM等待用户回复
  2. 在流式响应中，检测是否包含问题，如果有问题则停止并等待
  3. 确保LLM理解"询问后必须等待用户回复"
- **测试**：验证询问后正确等待用户输入

### 阶段3：多智能体对话修复

#### 3.1 修复事件处理逻辑
- **问题**：收到253个事件但没有生成消息
- **检查点**：
  1. `agents_service.py`中的事件处理逻辑
  2. 消息生成和yield逻辑
  3. 事件类型过滤和处理
- **解决方案**：
  1. 检查事件处理循环
  2. 确保所有事件都被正确处理
  3. 确保消息被正确生成和yield
- **测试**：验证多智能体对话能正确生成消息

### 阶段4：智能体连接修复

#### 4.1 修复handoffs配置
- **问题**：生成的智能体没有正确连接到其他智能体
- **原项目逻辑**：
  1. 通过`@agent:name` mention检测连接
  2. 在创建agent时设置handoffs
  3. 使用`_get_handoff_agent_names`函数获取连接的智能体
- **解决方案**：
  1. 检查智能体instructions中的`@agent:name` mentions
  2. 确保handoffs正确设置
  3. 验证智能体连接逻辑
- **测试**：验证智能体能正确连接和handoff

### 阶段5：工具匹配修复

#### 5.1 修复工具配置到智能体
- **问题**：搜索到的工具没有正确匹配并配置到智能体
- **原项目逻辑**：
  1. 工具先添加到workflow.tools
  2. 然后在agent的tools字段中引用工具名称
  3. 使用工具名称（不是slug）进行匹配
- **解决方案**：
  1. 确保工具正确添加到workflow
  2. 确保agent的tools字段使用正确的工具名称
  3. 验证工具匹配逻辑
- **测试**：验证工具正确配置到智能体

### 阶段6：系统提示词对比和修复

#### 6.1 对比原项目提示词
- **检查点**：
  1. 工具搜索相关指令
  2. 用户交互相关指令
  3. 智能体创建相关指令
  4. 工具配置相关指令
- **解决方案**：
  1. 逐行对比原项目提示词
  2. 修复不一致的地方
  3. 确保所有关键指令都存在
- **测试**：验证提示词逻辑与原项目一致

## 执行顺序

1. **阶段1**：工具搜索修复（最紧急）
2. **阶段2**：用户交互修复
3. **阶段3**：多智能体对话修复
4. **阶段4**：智能体连接修复
5. **阶段5**：工具匹配修复
6. **阶段6**：系统提示词修复

## 测试计划

每个阶段完成后：
1. 单元测试：测试修复的功能点
2. 集成测试：测试与其他功能的集成
3. 端到端测试：测试完整流程
4. 对比测试：与原项目行为对比

## 注意事项

- 保持向后兼容
- 不影响已有功能
- 逐步修复，每步都测试
- 详细记录修改内容

