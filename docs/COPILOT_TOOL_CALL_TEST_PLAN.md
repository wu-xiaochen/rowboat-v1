# Copilot 工具调用功能完整测试计划

## 测试目标

验证 Copilot 工具调用功能（复刻原项目实现）的正确性，包括：
1. 多轮工具调用迭代
2. 消息顺序正确性
3. 错误处理
4. 前后端集成
5. 用户体验

## 测试环境准备

### 前置条件

1. **后端服务**：
   ```bash
   cd backend
   uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload
   ```

2. **前端服务**：
   ```bash
   cd apps/rowboat
   npm run dev
   ```

3. **环境变量配置**：
   - 确保 `.env` 中配置了正确的 LLM API 密钥和基础 URL
   - 确保 `USE_COMPOSIO_TOOLS=true`（如果使用 Composio 工具）

4. **数据库服务**：
   - MongoDB 运行在 `localhost:27017`
   - Redis 运行在 `localhost:6379`（如需要）

## 测试用例

### 1. 基础功能测试

#### 1.1 简单对话测试（无工具调用）

**测试步骤**：
1. 打开 Copilot 界面
2. 发送消息："你好，请介绍一下你自己"
3. 观察响应

**预期结果**：
- ✅ 前端能正常接收流式响应
- ✅ 文本内容正确显示
- ✅ 无工具调用事件
- ✅ 响应完成后状态正确

**验证点**：
- [ ] 流式响应正常
- [ ] 文本内容正确显示
- [ ] 无错误信息
- [ ] 加载状态正确切换

---

#### 1.2 工具调用测试（单轮）

**测试步骤**：
1. 打开 Copilot 界面
2. 发送消息："搜索邮件发送相关的工具"
3. 观察响应

**预期结果**：
- ✅ 前端接收到 `tool-call` 事件
- ✅ 工具调用信息正确显示（工具名称、参数）
- ✅ 工具执行完成后接收到 `tool-result` 事件
- ✅ LLM 基于工具结果继续生成回复
- ✅ 最终回复包含工具搜索结果

**验证点**：
- [ ] `tool-call` 事件正确接收
- [ ] 工具名称：`search_relevant_tools`
- [ ] 工具参数包含 `query` 字段
- [ ] `tool-result` 事件正确接收
- [ ] 工具结果正确显示
- [ ] LLM 最终回复包含工具信息

---

#### 1.3 多轮工具调用测试

**测试步骤**：
1. 打开 Copilot 界面
2. 发送消息："帮我搜索邮件发送工具，然后搜索日历管理工具"
3. 观察响应

**预期结果**：
- ✅ 第一轮：调用 `search_relevant_tools`（邮件发送）
- ✅ 第二轮：调用 `search_relevant_tools`（日历管理）
- ✅ 最多执行 10 轮迭代
- ✅ 每轮工具调用和结果正确显示
- ✅ 最终回复整合所有工具结果

**验证点**：
- [ ] 多轮工具调用正确执行
- [ ] 消息顺序正确（AIMessage → ToolMessage → AIMessage → ToolMessage）
- [ ] 工具调用 ID 匹配
- [ ] 每轮结果正确显示
- [ ] 最终回复整合所有信息

---

### 2. 错误处理测试

#### 2.1 后端错误响应测试

**测试步骤**：
1. 停止后端服务
2. 在前端发送消息
3. 观察错误处理

**预期结果**：
- ✅ 前端正确捕获错误
- ✅ 错误信息以字符串形式显示（不是对象）
- ✅ 错误提示清晰
- ✅ 可以重试

**验证点**：
- [ ] 错误信息是字符串，不是对象
- [ ] 错误提示清晰："Failed to start stream" 或具体错误信息
- [ ] 无 React 渲染错误
- [ ] 重试按钮可用

---

#### 2.2 流式响应错误测试

**测试步骤**：
1. 模拟后端返回错误事件（`event: error`）
2. 观察前端错误处理

**预期结果**：
- ✅ 前端正确解析错误事件
- ✅ 错误信息以字符串形式显示
- ✅ 流式响应正确终止
- ✅ 状态正确重置

**验证点**：
- [ ] 错误事件正确解析
- [ ] 错误信息是字符串
- [ ] 无 React 渲染错误
- [ ] 加载状态正确重置

---

#### 2.3 工具调用错误测试

**测试步骤**：
1. 模拟工具执行失败
2. 观察错误处理

**预期结果**：
- ✅ 工具错误不影响整体流程
- ✅ 错误信息正确显示
- ✅ LLM 可以继续生成回复

**验证点**：
- [ ] 工具错误正确捕获
- [ ] 错误信息正确显示
- [ ] 流程继续执行

---

### 3. 消息顺序验证测试

#### 3.1 工具调用消息顺序测试

**测试步骤**：
1. 发送触发工具调用的消息
2. 检查后端日志中的消息顺序
3. 验证前端显示顺序

**预期结果**：
- ✅ 后端消息顺序：`AIMessage`（含 `tool_calls`）→ `ToolMessage`
- ✅ 前端事件顺序：`tool-call` → `tool-result`
- ✅ 无 "Message has tool role, but there was no previous assistant message" 错误

**验证点**：
- [ ] 后端日志显示正确的消息顺序
- [ ] 无 OpenAI API 错误（20015）
- [ ] 前端事件顺序正确
- [ ] 工具调用 ID 匹配

---

#### 3.2 多轮迭代消息顺序测试

**测试步骤**：
1. 发送触发多轮工具调用的消息
2. 检查每轮的消息顺序
3. 验证整体消息历史

**预期结果**：
- ✅ 每轮迭代消息顺序正确
- ✅ 消息历史完整
- ✅ 无消息顺序错误

**验证点**：
- [ ] 每轮消息顺序正确
- [ ] 消息历史完整
- [ ] 无重复消息
- [ ] 无缺失消息

---

### 4. 性能测试

#### 4.1 响应时间测试

**测试步骤**：
1. 发送简单消息，记录响应时间
2. 发送工具调用消息，记录响应时间
3. 发送多轮工具调用消息，记录响应时间

**预期结果**：
- ✅ 简单消息响应时间 < 5秒
- ✅ 单轮工具调用响应时间 < 15秒
- ✅ 多轮工具调用响应时间 < 60秒（10轮）

**验证点**：
- [ ] 响应时间在可接受范围内
- [ ] 无超时错误
- [ ] 流式响应流畅

---

#### 4.2 并发测试

**测试步骤**：
1. 同时发送多个 Copilot 请求
2. 观察响应情况

**预期结果**：
- ✅ 每个请求独立处理
- ✅ 无请求互相干扰
- ✅ 响应正确

**验证点**：
- [ ] 并发请求正常处理
- [ ] 无请求丢失
- [ ] 响应正确

---

### 5. 边界条件测试

#### 5.1 最大迭代次数测试

**测试步骤**：
1. 发送需要超过 10 轮工具调用的消息
2. 观察是否在 10 轮后停止

**预期结果**：
- ✅ 最多执行 10 轮迭代
- ✅ 10 轮后正确停止
- ✅ 提示信息清晰

**验证点**：
- [ ] 迭代次数限制正确
- [ ] 停止逻辑正确
- [ ] 提示信息清晰

---

#### 5.2 空响应测试

**测试步骤**：
1. 发送消息，模拟 LLM 返回空响应
2. 观察处理情况

**预期结果**：
- ✅ 正确处理空响应
- ✅ 显示默认提示信息
- ✅ 无错误

**验证点**：
- [ ] 空响应正确处理
- [ ] 默认提示信息显示
- [ ] 无错误

---

#### 5.3 工具调用 ID 缺失测试

**测试步骤**：
1. 模拟工具调用 ID 缺失的情况
2. 观察处理情况

**预期结果**：
- ✅ 自动生成工具调用 ID
- ✅ 工具调用正常执行
- ✅ 无错误

**验证点**：
- [ ] ID 自动生成
- [ ] 工具调用正常
- [ ] 无错误

---

### 6. 用户体验测试

#### 6.1 加载状态显示

**测试步骤**：
1. 发送消息
2. 观察加载状态

**预期结果**：
- ✅ 加载状态正确显示
- ✅ 工具调用时显示特殊状态
- ✅ 状态切换流畅

**验证点**：
- [ ] 加载状态正确
- [ ] 工具调用状态正确
- [ ] 状态切换流畅

---

#### 6.2 工具调用信息显示

**测试步骤**：
1. 发送触发工具调用的消息
2. 观察工具调用信息显示

**预期结果**：
- ✅ 工具调用信息清晰显示
- ✅ 工具名称和参数可见
- ✅ 工具结果正确显示

**验证点**：
- [ ] 工具调用信息清晰
- [ ] 工具名称和参数可见
- [ ] 工具结果正确显示

---

#### 6.3 错误提示显示

**测试步骤**：
1. 触发各种错误场景
2. 观察错误提示

**预期结果**：
- ✅ 错误提示清晰
- ✅ 错误信息可读
- ✅ 重试功能可用

**验证点**：
- [ ] 错误提示清晰
- [ ] 错误信息可读
- [ ] 重试功能可用

---

### 7. 集成测试

#### 7.1 前后端完整流程测试

**测试步骤**：
1. 从前端发送消息
2. 观察后端处理
3. 观察前端响应

**预期结果**：
- ✅ 前后端通信正常
- ✅ 数据格式正确
- ✅ 响应正确

**验证点**：
- [ ] 前后端通信正常
- [ ] 数据格式正确
- [ ] 响应正确

---

#### 7.2 Composio 工具集成测试

**测试步骤**：
1. 确保 Composio 配置正确
2. 发送搜索工具的消息
3. 观察工具搜索结果

**预期结果**：
- ✅ Composio 工具正确调用
- ✅ 搜索结果正确返回
- ✅ 工具信息正确显示

**验证点**：
- [ ] Composio 工具调用成功
- [ ] 搜索结果正确
- [ ] 工具信息正确显示

---

## 测试检查清单

### 功能检查清单

- [ ] 简单对话正常
- [ ] 单轮工具调用正常
- [ ] 多轮工具调用正常
- [ ] 消息顺序正确
- [ ] 错误处理正确
- [ ] 性能可接受
- [ ] 边界条件处理正确
- [ ] 用户体验良好

### 代码质量检查清单

- [ ] 无 React 渲染错误
- [ ] 错误信息是字符串，不是对象
- [ ] 无控制台错误
- [ ] 无网络错误
- [ ] 日志清晰

### 兼容性检查清单

- [ ] 与现有功能兼容
- [ ] 不影响其他功能
- [ ] 数据格式兼容

---

## 测试执行记录

### 测试日期：___________

### 测试人员：___________

### 测试结果：

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 1.1 简单对话测试 | ⬜ 通过 / ⬜ 失败 | |
| 1.2 工具调用测试（单轮） | ⬜ 通过 / ⬜ 失败 | |
| 1.3 多轮工具调用测试 | ⬜ 通过 / ⬜ 失败 | |
| 2.1 后端错误响应测试 | ⬜ 通过 / ⬜ 失败 | |
| 2.2 流式响应错误测试 | ⬜ 通过 / ⬜ 失败 | |
| 2.3 工具调用错误测试 | ⬜ 通过 / ⬜ 失败 | |
| 3.1 工具调用消息顺序测试 | ⬜ 通过 / ⬜ 失败 | |
| 3.2 多轮迭代消息顺序测试 | ⬜ 通过 / ⬜ 失败 | |
| 4.1 响应时间测试 | ⬜ 通过 / ⬜ 失败 | |
| 4.2 并发测试 | ⬜ 通过 / ⬜ 失败 | |
| 5.1 最大迭代次数测试 | ⬜ 通过 / ⬜ 失败 | |
| 5.2 空响应测试 | ⬜ 通过 / ⬜ 失败 | |
| 5.3 工具调用 ID 缺失测试 | ⬜ 通过 / ⬜ 失败 | |
| 6.1 加载状态显示 | ⬜ 通过 / ⬜ 失败 | |
| 6.2 工具调用信息显示 | ⬜ 通过 / ⬜ 失败 | |
| 6.3 错误提示显示 | ⬜ 通过 / ⬜ 失败 | |
| 7.1 前后端完整流程测试 | ⬜ 通过 / ⬜ 失败 | |
| 7.2 Composio 工具集成测试 | ⬜ 通过 / ⬜ 失败 | |

---

## 问题记录

### 问题 1：
- **描述**：
- **严重程度**：⬜ 严重 / ⬜ 中等 / ⬜ 轻微
- **状态**：⬜ 待修复 / ⬜ 已修复
- **修复方案**：

---

## 测试总结

### 通过率：___ / 18 (___%)

### 主要问题：
1. 
2. 
3. 

### 建议：
1. 
2. 
3. 

---

## 附录

### A. 测试工具

- **浏览器**：Chrome / Firefox / Safari
- **测试工具**：浏览器开发者工具、Postman（如需要）
- **日志查看**：后端日志、前端控制台

### B. 测试数据

- **测试项目 ID**：`648cc3ed-ab31-4071-a220-8c32e3712c77`
- **测试消息示例**：
  - "你好"
  - "搜索邮件发送工具"
  - "搜索日历管理和邮件发送工具"

### C. 参考文档

- `docs/COPILOT_TOOL_CALL_IMPLEMENTATION.md` - 实现文档
- `docs/TOOL_CALL_FIX_SUMMARY.md` - 修复总结
- 原项目实现：`apps/rowboat/src/application/lib/copilot/copilot.ts`

